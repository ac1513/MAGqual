---
title: "`r prefix` MAGqual output report"
author: "Source: https://github.com/ac1513/MAGqual"
#date: "Date generated: `r format(Sys.Date(), '%d/%m/%Y')`"
output: 
  html_document:
      css: mystyle.css
      toc: true
      toc_float: true
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(reticulate)
library(tidyr)
library(DT)
library(ggplot2)
library(plotly)
use_python("/Users/ac1513/miniconda3/envs/basic3_intel/bin/python")
```


```{python, include=FALSE, warning=FALSE}
import pandas as pd
import glob

files = glob.glob("analysis/*mag_qual_statistics.csv")
quality = pd.DataFrame(index= ['High Quality', 'Near Complete', 'Medium Quality', 'Low Quality', 'Failed'])
summary = pd.DataFrame()
names = []
comp_con = pd.DataFrame()
N50 = pd.DataFrame() 
size = pd.DataFrame()
tRNA = pd.DataFrame()

for file in files:
    basename = file.split('/')[1][::-1][24:][::-1] # get the ID of the MAGqual run
    statistics = pd.read_csv(file)
    statistics["Bin Id"] = statistics["Bin Id"].astype(str)
    qual = statistics["Quality"].value_counts()
    quality[basename] = qual
    mean = statistics.mean(numeric_only=True)
    mean.index = mean.index.values + "_mean"
    std =  statistics.std(numeric_only=True)
    std.index =  std.index.values + "_std"
    num = statistics["Bin Id"].count()
    stats = pd.Series([int(statistics["Bin Id"].count()), int(statistics["Size_bp"].sum()), int(statistics["No_contigs"].sum())], index=["No_bins", "Total_binned_bp", "Total_no_contigs_binned"])
    summary[str(basename)] = pd.concat([mean, std, stats])
    names.append(basename)
    comp_con[basename +"_comp"] = statistics["Completeness"]
    comp_con[basename +"_con"] = statistics["Contamination"]
    N50[basename] = statistics["N50_length"]
    size[basename] = statistics["Size_bp"]
    tRNA[basename] = statistics["tRNA_Extracted"]
    
quality = quality.T.fillna(0) 
summary = summary.T.fillna(0)
```

```{r, echo=FALSE, warning=FALSE}
summary <- py$summary
quality <- py$quality
quality$"Total Bins" <- rowSums(quality)
```

> #### Note: Report input files  
> This report has been generated using the below files, if you are missing any samples please add the summary statistics CSV into the `./analysis/` directory and re-run this script.
> <details><summary>Files:</summary>
> ```{r, echo=FALSE}
> py$files
> ```
> </details>
>

<br>  
  
## Overall bin quality

<br>
  
<font size="3"><b>Table 1: Overall MAG quality of `r toString(py$names)` and total number of MAGs generated by each method. </b></font>
```{r, echo=FALSE, warning=FALSE}
DT::datatable(quality, options = list(dom = "t"))
```
<br>
<br>  

## Binning comparison 

```{r, echo=FALSE, warning=FALSE}
summary_total <- summary[,c("Total_binned_bp", "Total_no_contigs_binned")]
summary_total <- tibble::rownames_to_column(summary_total, "Method")
summary_total_long <- summary_total %>% pivot_longer(names_to = "Metric", cols = c("Total_binned_bp", "Total_no_contigs_binned"))

binning <- ggplot(summary_total_long, aes(x=Method, y=value, fill = Method)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~Metric, scales = "free_y", strip.position = "left", labeller = as_labeller(c(Total_binned_bp = "Total bases binned (bp)", Total_no_contigs_binned = "Total number of contigs binned")))+
  ylab(NULL) +
  theme(legend.position="none", strip.text = element_text(face="bold", size=12), strip.background = element_blank(), strip.placement = "outside", axis.line = element_line(linewidth = 0.3)) + 
  scale_y_continuous(expand = c(0, 0))+ 
  theme(axis.text = element_text( 
    angle = 90)) + theme(panel.background = element_blank()) +
  xlab(NULL) + 
  scale_fill_brewer(palette = "Set2")

pp <- ggplotly(binning)

invisible(
  lapply(1:length(pp$x$layout$shapes),
         function(i) {       # if a strip shape (using the strip color)
           if(i <= length(pp$x$layout$annotations)) { # if the text is a strip label
             if(any(pp$x$layout$annotations[[i]]$text %in% c("Total number of contigs binned", "Total bases binned (bp)"))) {
               pp$x$layout$annotations[[i]]$yanchor <<- "center"
               pp$x$layout$annotations[[i]]$y <<- pp$x$layout$annotations[[i]]$y - 0.5
               pp$x$layout$annotations[[i]]$x <<- pp$x$layout$annotations[[i]]$x-0.29 # move text to the middle
               pp$x$layout$annotations[[i]]$textangle <<- 270
             }
           }
         })) 

pp %>% layout()

```

<font size="3"><b> Figure 1: Total number of bases and contigs binned for `r toString(py$names)` </b></font>  
<br>

```{r, echo=FALSE, warning=FALSE}
comp_total <- py$comp_con
comp_total_long <- comp_total %>% pivot_longer(cols=everything())
comp_total_long$Metric <- ifelse(grepl("_comp", comp_total_long$name), "Completeness", "Contamination")
comp_total_long <- comp_total_long[complete.cases(comp_total_long), ]
comp_total_long$name <- gsub('_comp', '', comp_total_long$name)
comp_total_long$name <- gsub('_con', '', comp_total_long$name)

comp <- ggplot(comp_total_long, aes(x=name, y=value, fill = name)) + 
  geom_boxplot(outlier.colour="black", outlier.shape=16,
             outlier.size=2, notch=FALSE) +
  ylab("Contamination / Completeness (%)") +
  theme(axis.line = element_line(linewidth =0.3), legend.position="none") + 
  facet_wrap(~Metric, scales = "free") +
  #scale_y_continuous(expand = c(0, 0))+ 
  ylim(0,100)+
  theme(axis.text = element_text( 
    angle = 90)) + theme(panel.background = element_blank()) +
  xlab(NULL) + 
  scale_fill_brewer(palette = "Set2")

ggplotly(comp)
```
<font size="3"><b> Figure 2: Distribution of the completeness and contamination of `r toString(py$names)`. </b></font>
<br>
<br>  

### Additional plots {.tabset}

#### N50 length
```{r, echo=FALSE, warning=FALSE}
N50 <- py$N50
N50_long <- N50 %>% pivot_longer(cols=everything())
N50_long <- N50_long[complete.cases(N50_long), ]

N50_plot <- ggplot(N50_long, aes(x=name, y=value, fill = name)) +
  geom_boxplot(outlier.colour="black", outlier.shape=16,
             outlier.size=2, notch=FALSE) +
  ylab("Length (bp)") +
  theme(axis.line = element_line(linewidth =0.3), legend.position="none") + 
  theme(axis.text = element_text(angle = 90)) + 
  theme(panel.background = element_blank()) +
  xlab(NULL) + 
  scale_fill_brewer(palette = "Set2")

ggplotly(N50_plot)
```
<font size="3"><b> Figure 3: Distribution of the the N50 lengths (bp) of the bins generated by `r toString(py$names)`. </b></font>
  
<br>  
<br>  

#### Total length

```{r, echo=FALSE}
size <- py$size
size_long <- size %>% pivot_longer(cols=everything())
size_long <- size_long[complete.cases(size_long), ]

size_plot <- ggplot(size_long, aes(x=name, y=value, fill = name)) +
  geom_boxplot(outlier.colour="black", outlier.shape=16,
             outlier.size=2, notch=FALSE) +
  ylab("Length (bp)") +
  theme(axis.line = element_line(linewidth =0.3), legend.position="none") + 
  theme(axis.text = element_text(angle = 90)) + 
  theme(panel.background = element_blank()) +
  xlab(NULL) + 
  scale_fill_brewer(palette = "Set2")

ggplotly(size_plot)
```
<font size="3"><b> Figure 4: Distribution of the the length (bp) of the bins generated by `r toString(py$names)`. </b></font>
  
<br>  
<br>  

#### Number of tRNAs encoded
```{r, echo=FALSE, warning=FALSE}
tRNA <- py$tRNA
tRNA_long <- tRNA %>% pivot_longer(cols=everything())
tRNA_long <- tRNA_long[complete.cases(tRNA_long), ]

size_plot <- ggplot(tRNA_long, aes(x=name, y=value, fill = name)) +
  geom_boxplot(outlier.colour="black", outlier.shape=16,
             outlier.size=2, notch=FALSE) +
  ylab("Length (bp)") +
  theme(axis.line = element_line(linewidth =0.3), legend.position="none") + 
  theme(axis.text = element_text(angle = 90)) + 
  theme(panel.background = element_blank()) +
  xlab(NULL) + 
  scale_fill_brewer(palette = "Set2")

ggplotly(size_plot)
```
<font size="3"><b> Figure 5: Distribution of the the number of unique tRNA sequences (/20) extracted in the bins generated by `r toString(py$names)`. </b></font>  
  
<br>  
<br>  
  
## Metadata tables {.tabset}
```{r, echo=FALSE, warning=FALSE}
library(DT)
library(htmltools)
jsc <- 'function(settings, json) { $(this).parents(".datatables").remove(); }'
datatable(matrix(NA, 2, 2), options = list("initComplete" = JS(jsc)))
```

```{r, echo=FALSE, warning=FALSE, results='asis'}
for(file in py$files) {
  basename = substr(basename(file), 1, nchar(basename(file))-24) # get the ID of the MAGqual run
  cat('\n###', basename, '\n')
  print(htmltools::tagList(DT::datatable(read.csv(file), options = list(scrollX='400px'))))
}
```

